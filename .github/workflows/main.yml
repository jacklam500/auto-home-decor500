name: Auto Home Design Generator

on:
  schedule:
    - cron: "0 2 * * *"   # 每天 UTC 2 点运行
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Dependencies
        run: |
          pip install requests pillow

      - name: Generate Image with HuggingFace
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          mkdir -p outputs

          python3 <<EOF
import requests

API_URL = "https://api-inference.huggingface.co/models/black-forest-labs/FLUX.1-schnell"
headers = {"Authorization": f"Bearer ${HF_TOKEN}"}

payload = {
    "inputs": "modern luxury living room, warm lighting, high-end interior, natural wood tones, marble textures, cinematic photo, 4k",
    "parameters": {
        "height": 1024,
        "width": 768,
        "guidance_scale": 3.5
    }
}

response = requests.post(API_URL, headers=headers, json=payload)

if response.status_code != 200:
    print("Error:", response.text)
    exit()

with open("outputs/home_design.png", "wb") as f:
    f.write(response.content)

print("Image saved!")
EOF

      - name: Generate Caption
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python3 <<EOF
import requests

API_URL = "https://api-inference.huggingface.co/models/meta-llama/Llama-3.2-3B-Instruct"
headers = {"Authorization": f"Bearer ${HF_TOKEN}"}

prompt = """
请为这张家居设计图写一段适合小红书/抖音的文案，要求：
- 有高级感
- 真实自然
- 20 字以内
- 强调氛围、光影、质感
输出格式：
【文案】
"""

data = {"inputs": prompt}
res = requests.post(API_URL, headers=headers, json=data)

try:
    text = res.json()[0]["generated_text"]
except:
    text = "高品质家居空间，让生活更舒适。"

with open("outputs/caption.txt", "w", encoding="utf-8") as f:
    f.write(text)

print("Caption generated!")
EOF

      - name: Commit Results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          git add outputs/*
          git commit -m "Auto-generated home design content" || echo "No changes"
          git push
